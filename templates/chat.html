<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8" />
<title>Чат</title>
<style>
 body {
  font-family: Verdana, Arial, sans-serif;
  background: #f4f4f4;
  color: #333;
  margin: 20px auto;
  padding: 10px;
  max-width: 900px;
  border: 1px solid #ccc;
  background-image: linear-gradient(to bottom, #ffffff, #e5e5e5);
}

h2 {
  text-align: center;
  color: #000080;
  font-size: 24px;
  margin-bottom: 20px;
  text-shadow: 1px 1px 0 #ccc;
}

#messages {
  height: 400px;
  overflow-y: auto;
  padding: 10px;
  background: #fff;
  border: 1px solid #999;
  border-radius: 4px;
  box-shadow: inset 0 0 5px #ddd;
  font-size: 14px;
}

.message {
  padding: 4px 0;
  border-bottom: 1px dashed #ccc;
}

.username {
  font-weight: bold;
  color: #003366;
  cursor: pointer;
}

.reply-btn {
  margin-left: 6px;
  font-size: 12px;
  color: #006600;
  cursor: pointer;
}

.reply-btn:hover {
  text-decoration: underline;
}

#input-area {
  display: flex;
  gap: 8px;
  margin-top: 15px;
}

#input-area input[type="text"] {
  flex-grow: 1;
  padding: 8px;
  font-size: 14px;
  border: 1px solid #aaa;
  border-radius: 4px;
  background: #fdfdfd;
  box-shadow: inset 0 1px 2px #ccc;
}

#input-area input[type="text"]:focus {
  border-color: #6699cc;
  background: #fff;
  outline: none;
}

#input-area button {
  padding: 8px 16px;
  background: linear-gradient(to bottom, #d0e4ff, #a3c4f3);
  border: 1px solid #6699cc;
  color: #003366;
  font-weight: bold;
  border-radius: 4px;
  cursor: pointer;
  box-shadow: 0 2px 5px #ccc;
}

#input-area button:hover {
  background: linear-gradient(to bottom, #a3c4f3, #d0e4ff);
}

/* Ссылки на файлы */
.file-link {
  color: #0066cc;
  text-decoration: underline;
}

.file-link:hover {
  color: #004a99;
}

.file-image {
  max-width: 180px;
  max-height: 120px;
  border: 1px solid #ccc;
  margin-top: 5px;
  border-radius: 4px;
}

.divider {
  text-align: center;
  font-weight: bold;
  color: #666;
  margin: 10px 0;
}

/* Индикаторы статуса */
.status-indicator {
  display: inline-block;
  width: 10px;
  height: 10px;
  border-radius: 50%;
  margin-right: 5px;
  vertical-align: middle;
}
.online {
  background-color: #00cc00;
}
.offline {
  background-color: #cc0000;
}

.status-text {
  font-size: 12px;
  font-weight: bold;
  margin-right: 5px;
}
</style>
<script src="https://cdn.socket.io/4.5.4/socket.io.min.js"></script>
</head>
<body>

<h2>Чат <a href="/logout" id="logout-link" style="color: #4caf50; font-size: 14px; margin-left: 15px; text-decoration: none;">Выход</a></h2>
<div id="messages"></div>

<!-- Добавленный разделитель -->
<div class="divider">--------</div>

<div id="input-area">
  <input type="text" id="msg-input" placeholder="Введите сообщение..." autocomplete="off" />
  <button id="send-btn">Отправить</button>
</div>

<!-- Скрытый input для загрузки файлов -->
<input type="file" id="file-input" class="hidden-file-input" />

<script>
  const socket = io();

  const messagesDiv = document.getElementById('messages');
  const input = document.getElementById('msg-input');
  const sendBtn = document.getElementById('send-btn');
  const fileInput = document.getElementById('file-input');

  // Для хранения ника пользователя, которому отправляем файл
  let fileSendTarget = null;

  function addMessage(msg) {
    const div = document.createElement('div');
    div.className = 'message';

    // Индикатор статуса
    const statusSpan = document.createElement('span');
    statusSpan.className = 'status-indicator';

    // Текст статуса [online]/[offline]
    const status = userStatuses[msg.user];
    if (status === 'online') {
      statusSpan.classList.add('online');
    } else {
      statusSpan.classList.add('offline');
    }

    const usernameSpan = document.createElement('span');
    usernameSpan.textContent = msg.user;
    usernameSpan.className = 'username';
    usernameSpan.title = 'Нажмите, чтобы ответить или отправить файл';

    // Клик на ник — выбор файла для отправки
    usernameSpan.addEventListener('click', () => {
      fileSendTarget = msg.user;
      fileInput.click();
    });

    const replyBtn = document.createElement('span');
    replyBtn.textContent = '[Ответить]';
    replyBtn.className = 'reply-btn';
    replyBtn.addEventListener('click', () => {
      input.value = '@' + msg.user + ', ';
      input.focus();
    });

    // Добавляем все в div сообщения: статус, ник, кнопка ответить
    div.appendChild(statusSpan);
    div.appendChild(usernameSpan);
    div.appendChild(replyBtn);

    // Если файл — показываем превью или ссылку для скачивания
    if (msg.file) {
      const mimeType = msg.file.type || '';

      if (mimeType.startsWith('image/')) {
        const a = document.createElement('a');
        a.href = msg.file.data;
        a.download = msg.file.name;
        a.title = 'Скачать ' + msg.file.name;

        const img = document.createElement('img');
        img.src = msg.file.data;
        img.alt = msg.file.name;
        img.className = 'file-image';

        a.appendChild(img);
        div.appendChild(document.createTextNode(': '));
        div.appendChild(a);
      } else {
        const a = document.createElement('a');
        a.href = msg.file.data;
        a.textContent = `[Файл: ${msg.file.name}]`;
        a.className = 'file-link';
        a.target = '_blank';
        a.download = msg.file.name;
        div.appendChild(document.createTextNode(': '));
        div.appendChild(a);
      }
    } else {
      // Обычный текст
      const textSpan = document.createElement('span');
      textSpan.textContent = ': ' + msg.text;
      div.appendChild(textSpan);
    }

    messagesDiv.appendChild(div);
    messagesDiv.scrollTop = messagesDiv.scrollHeight;
  }

  // Обновляем статус пользователей
  socket.on('user_statuses', (statuses) => {
    userStatuses = statuses;
  });

  socket.on('load_messages', msgs => {
    messagesDiv.innerHTML = '';
    msgs.forEach(addMessage);
  });

  socket.on('new_message', addMessage);

  socket.on('new_file', msg => {
    addMessage({
      user: msg.user,
      file: {
        name: msg.filename,
        type: msg.filedata.split(';')[0].split(':')[1], // mime type из data URI
        data: msg.filedata
      }
    });
  });

  sendBtn.addEventListener('click', () => {
    const text = input.value.trim();
    if (!text) return;
    socket.emit('send_message', { text });
    input.value = '';
  });

  input.addEventListener('keydown', e => {
    if (e.key === 'Enter') {
      sendBtn.click();
      e.preventDefault();
    }
  });

  fileInput.addEventListener('change', () => {
    const file = fileInput.files[0];
    if (!file) return;

    const reader = new FileReader();

    reader.onload = () => {
      socket.emit('send_file', {
        toUser: fileSendTarget,
        filename: file.name,
        filedata: reader.result
      });
      fileInput.value = '';
      fileSendTarget = null;
    };

    reader.readAsDataURL(file);
  });
</script>

</body>
</html>
