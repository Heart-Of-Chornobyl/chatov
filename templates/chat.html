<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>–ß–∞—Ç —Å —Ñ–∞–π–ª–∞–º–∏</title>
<!-- Socket.IO –∏ Supabase -->
<script src="https://cdn.socket.io/4.5.4/socket.io.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script>
<style>
/* –¢–≤–æ–∏ —Å—Ç–∏–ª–∏ —á–∞—Ç–∞ (–≤–∑—è—Ç—ã –∏–∑ –ø—Ä–∏–º–µ—Ä–∞) */
body, html { margin:0; padding:0; height:100%; background:#121916; color:#c1d8c1;
  font-family:'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
  display:flex; flex-direction:column; user-select:none;
}
h2{margin:0;padding:20px 0;text-align:center;font-weight:700;font-size:1.5rem;
  color:#7fa57f;text-shadow:0 0 5px #4a6f4a;background:#1e2a20;border-bottom:1px solid #3a553a;
  display:flex;justify-content:center;align-items:center;
}
#messages{flex-grow:1;overflow-y:auto;padding:15px;background:#1e2a20;border-top:1px solid #3a553a;border-bottom:1px solid #3a553a;}
.message{margin-bottom:12px;line-height:1.3;}
.message .username{font-weight:700;color:#7fa57f;cursor:default;}
.message .reply-btn{margin-left:8px;font-size:0.8rem;color:#a8c6a8;cursor:pointer;}
.message .reply-btn:hover{color:#4caf50;text-decoration:underline;}
.status-indicator{display:inline-block;width:10px;height:10px;border-radius:50%;margin-right:6px;vertical-align:middle;}
.online{background-color:#4caf50;} .offline{background-color:#7a7a7a;}
.message-text{margin-left:18px;display:inline-block;vertical-align:middle;word-break:break-word;}
.file-link{color:#81c784;text-decoration:underline;cursor:pointer;}
.file-link:hover{color:#4caf50;}
.file-image{max-width:180px;max-height:120px;border-radius:6px;margin-top:6px;border:1px solid #3a553a;display:block;cursor:pointer;}
#input-area{display:flex;gap:10px;padding:12px 15px;background:#1e2a20;border-top:1px solid #3a553a;align-items:center;}
#msg-input{flex-grow:1;padding:12px 15px;font-size:1rem;border:none;border-radius:25px;background:#2a3b2a;color:#c1d8c1;box-shadow:inset 0 0 5px #395039;outline:none;}
#msg-input::placeholder{color:#7fa57faa;}
#send-btn{background:#4caf50;border:none;color:#121916;font-weight:700;font-size:1rem;padding:0 20px;border-radius:25px;cursor:pointer;box-shadow:0 0 12px #4caf50;transition:0.3s;}
#send-btn:hover{background:#357a35;}
#attach-btn{font-size:1.5rem;background:none;border:none;color:#4caf50;cursor:pointer;padding:0;}
#attach-btn:hover{color:#357a35;}
.hidden-file-input{display:none;}
video {max-width:300px; max-height:200px; margin-top:6px; border-radius:6px; border:1px solid #3a553a;}
</style>
</head>
<body>

<h2>–ß–∞—Ç <a href="/logout" id="logout-link">–í—ã—Ö–æ–¥</a></h2>
<div id="messages" role="log" aria-live="polite"></div>

<div id="input-area">
  <input type="text" id="msg-input" placeholder="–í–≤–µ–¥–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ..." autocomplete="off" />
  <button id="send-btn">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
  <button id="attach-btn">üìé</button>
</div>
<input type="file" id="file-input" class="hidden-file-input" />

<script>
  const socket = io();

  // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Supabase
  const SUPABASE_URL = 'https://lbppkscrjvjzcjalwkg.supabase.co';
  const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImxicHBrc2NyanZ6ampjYWx3a2d1Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTI4Mjg0NjYsImV4cCI6MjA2ODQwNDQ2Nn0.hAWeui-XHDNZnDsJxLPtuNHHwhVG7ZD9USTX59zo85c'; // —Ç–≤–æ–π anon –∫–ª—é—á
  const supabase = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

  const messagesDiv = document.getElementById('messages');
  const input = document.getElementById('msg-input');
  const sendBtn = document.getElementById('send-btn');
  const attachBtn = document.getElementById('attach-btn');
  const fileInput = document.getElementById('file-input');
  let userStatuses = {};
  
  function addMessage(msg) {
    const div = document.createElement('div'); div.className = 'message';
    const status = document.createElement('span'); status.className = 'status-indicator ' + (userStatuses[msg.user]==='online'?'online':'offline');
    const user = document.createElement('span'); user.className = 'username'; user.textContent = msg.user;
    const reply = document.createElement('span'); reply.className = 'reply-btn'; reply.textContent = '[–û—Ç–≤–µ—Ç–∏—Ç—å]';
    reply.onclick = () => { input.value = '@'+msg.user+', '; input.focus(); };
    div.append(status, user, reply);

    if (msg.fileUrl) {
      const type = msg.fileType || '';
      const name = msg.fileName;
      if (type.startsWith('image/')) {
        const a = document.createElement('a'); a.href = msg.fileUrl; a.download = name;
        const img = document.createElement('img'); img.src = msg.fileUrl; img.alt = name; img.className='file-image';
        a.append(img); div.append(document.createTextNode(': '), a);
      } else if (type.startsWith('video/')) {
        const video = document.createElement('video'); video.controls=true; video.src=msg.fileUrl;
        const dl = document.createElement('a'); dl.href=msg.fileUrl; dl.download=name; dl.textContent=`–°–∫–∞—á–∞—Ç—å: ${name}`; dl.className='file-link';
        div.append(document.createTextNode(': '), video, dl);
      } else {
        const a = document.createElement('a');
        a.href = msg.fileUrl; a.download=name; a.textContent=`[–§–∞–π–ª: ${name}]`; a.className='file-link';
        div.append(document.createTextNode(': '), a);
      }
    } else {
      const text = document.createElement('span');
      text.className = 'message-text'; text.textContent = ': '+msg.text;
      div.append(text);
    }
    messagesDiv.appendChild(div);
    messagesDiv.scrollTop = messagesDiv.scrollHeight;
  }

  socket.on('user_statuses', s => userStatuses = s);
  socket.on('load_messages', msgs => { messagesDiv.innerHTML = ''; msgs.forEach(addMessage); });
  socket.on('new_message', addMessage);

  sendBtn.onclick = () => {
    const text = input.value.trim(); if (!text) return;
    socket.emit('send_message', { text });
    input.value = '';
  };
  input.addEventListener('keydown', e => { if(e.key==='Enter'){sendBtn.click();e.preventDefault();}});

  attachBtn.onclick = () => fileInput.click();

  fileInput.onchange = async () => {
    const file = fileInput.files[0]; if (!file) return;
    const path = `chat/${Date.now()}_${file.name}`;
    const { data, error } = await supabase.storage.from('bucket').upload(path, file);
    if (error) return alert('–û—à–∏–±–∫–∞: '+error.message);
    const pub = supabase.storage.from('bucket').getPublicUrl(data.path).data.publicUrl;
    socket.emit('send_message', { text: '', fileUrl: pub, fileType: file.type, fileName: file.name });
    fileInput.value = '';
  };
</script>

</body>
</html>
