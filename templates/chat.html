<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Чат</title>
  <style>
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      max-width: 600px;
      margin: 20px auto;
      background-color: #121916;
      color: #c1d8c1;
      user-select: none;
    }

    h2 {
      text-align: center;
      color: #7fa57f;
      text-shadow: 0 0 5px #4a6f4a;
      margin-bottom: 15px;
    }

    #messages {
      border: 1px solid #3a553a;
      height: 400px;
      overflow-y: scroll;
      padding: 10px;
      margin-bottom: 10px;
      background: #1e2a20;
      border-radius: 8px;
      box-shadow: inset 0 0 8px #223322;
    }

    .message {
      margin-bottom: 8px;
      line-height: 1.3;
    }

    .username {
      font-weight: 700;
      color: #80c080;
      cursor: pointer;
      text-shadow: 0 0 4px #4caf50;
      user-select: text;
      position: relative;
    }

    .reply-btn {
      margin-left: 8px;
      font-size: 12px;
      cursor: pointer;
      color: #4caf50;
      user-select: none;
      transition: color 0.3s ease;
    }

    .reply-btn:hover {
      color: #7fff7f;
    }

    #input-area {
      display: flex;
      gap: 6px;
    }

    #input-area input[type="text"] {
      flex-grow: 1;
      padding: 10px 12px;
      font-size: 16px;
      border: 1.5px solid #3a553a;
      border-radius: 6px;
      background: #2a3b2a;
      color: #c1d8c1;
      transition: border-color 0.3s ease, background-color 0.3s ease;
    }

    #input-area input[type="text"]:focus {
      border-color: #4caf50;
      background: #395039;
      outline: none;
      color: #e1f0e1;
    }

    #input-area button {
      padding: 10px 18px;
      font-size: 16px;
      background: #4caf50;
      border: none;
      border-radius: 6px;
      color: white;
      cursor: pointer;
      font-weight: 700;
      box-shadow: 0 0 8px #3a7d3a;
      transition: background-color 0.3s ease, box-shadow 0.3s ease;
    }

    #input-area button:hover {
      background: #3a8a3a;
      box-shadow: 0 0 12px #4caf50;
    }

    /* Скрытый инпут для файлов */
    .hidden-file-input {
      display: none;
    }

    /* Ссылка на файл */
    .file-link {
      color: #6fcf70;
      cursor: pointer;
      text-decoration: underline;
    }

    .file-link:hover {
      color: #a1e9a1;
    }

    /* Для превью изображений */
    .file-image {
      max-width: 200px;
      max-height: 150px;
      display: block;
      margin-top: 5px;
      border-radius: 6px;
      box-shadow: 0 0 6px #4caf50;
    }

    /* Медиазапросы для мобильных устройств */
    @media screen and (max-width: 768px) {
      body {
        width: 95%;
        margin: 10px auto;
      }

      #messages {
        height: 300px;
      }

      .message {
        font-size: 14px;
      }

      #input-area input[type="text"] {
        font-size: 14px;
        padding: 8px;
      }

      #input-area button {
        font-size: 14px;
        padding: 8px 15px;
      }
    }

    /* Для очень маленьких экранов */
    @media screen and (max-width: 480px) {
      #messages {
        height: 250px;
      }

      #input-area input[type="text"] {
        font-size: 13px;
        padding: 6px;
      }

      #input-area button {
        font-size: 13px;
        padding: 6px 12px;
      }
    }
  </style>
  <script src="https://cdn.socket.io/4.5.4/socket.io.min.js"></script>
</head>
<body>

<h2>Чат</h2>
<div id="messages"></div>

<div id="input-area">
  <input type="text" id="msg-input" placeholder="Введите сообщение..." autocomplete="off" />
  <button id="send-btn">Отправить</button>
</div>

<!-- Скрытый input для загрузки файлов -->
<input type="file" id="file-input" class="hidden-file-input" />

<script>
  const socket = io();

  const messagesDiv = document.getElementById('messages');
  const input = document.getElementById('msg-input');
  const sendBtn = document.getElementById('send-btn');
  const fileInput = document.getElementById('file-input');

  // Для хранения ника пользователя, которому отправляем файл
  let fileSendTarget = null;

  function addMessage(msg) {
    const div = document.createElement('div');
    div.className = 'message';

    const usernameSpan = document.createElement('span');
    usernameSpan.textContent = msg.user;
    usernameSpan.className = 'username';
    usernameSpan.title = 'Нажмите, чтобы ответить или отправить файл';

    // При клике на ник — открываем выбор файла для отправки
    usernameSpan.addEventListener('click', () => {
      fileSendTarget = msg.user;
      fileInput.click();
    });

    const replyBtn = document.createElement('span');
    replyBtn.textContent = '[Ответить]';
    replyBtn.className = 'reply-btn';

    function onReplyClick() {
      input.value = '@' + msg.user + ', ';
      input.focus();
    }
    replyBtn.addEventListener('click', onReplyClick);

    div.appendChild(usernameSpan);
    div.appendChild(replyBtn);

    // Если это файл — показываем ссылку или изображение с возможностью скачать
    if (msg.file) {
      const mimeType = msg.file.type || '';

      if (mimeType.startsWith('image/')) {
        const a = document.createElement('a');
        a.href = msg.file.data;
        a.download = msg.file.name;
        a.title = 'Скачать ' + msg.file.name;

        const img = document.createElement('img');
        img.src = msg.file.data;
        img.alt = msg.file.name;
        img.className = 'file-image';

        a.appendChild(img);
        div.appendChild(document.createTextNode(': '));
        div.appendChild(a);
      } else {
        const a = document.createElement('a');
        a.href = msg.file.data;
        a.textContent = `[Файл: ${msg.file.name}]`;
        a.className = 'file-link';
        a.target = '_blank';
        a.download = msg.file.name;
        div.appendChild(document.createTextNode(': '));
        div.appendChild(a);
      }
    } else {
      // Обычное текстовое сообщение
      const textSpan = document.createElement('span');
      textSpan.textContent = ': ' + msg.text;
      div.appendChild(textSpan);
    }

    messagesDiv.appendChild(div);
    messagesDiv.scrollTop = messagesDiv.scrollHeight;
  }

  socket.on('load_messages', msgs => {
    messagesDiv.innerHTML = '';
    msgs.forEach(addMessage);
  });

  socket.on('new_message', addMessage);

  // Принимаем файлы
  socket.on('new_file', msg => {
    addMessage({
      user: msg.user,
      file: {
        name: msg.filename,
        type: msg.filedata.split(';')[0].split(':')[1], // mime type из data URI
        data: msg.filedata
      }
    });
  });

  sendBtn.addEventListener('click', () => {
    const text = input.value.trim();
    if (!text) return;
    socket.emit('send_message', { text });
    input.value = '';
  });

  input.addEventListener('keydown', e => {
    if (e.key === 'Enter') {
      sendBtn.click();
      e.preventDefault();
    }
  });

  // Обработка выбора файла
  fileInput.addEventListener('change', () => {
    const file = fileInput.files[0];
    if (!file) return;

    const reader = new FileReader();

    reader.onload = () => {
      // Отправляем объект с информацией о файле и base64 содержимым
      socket.emit('send_file', {
        toUser: fileSendTarget,
        filename: file.name,
        filedata: reader.result
      });
      fileInput.value = '';
      fileSendTarget = null;
    };

    reader.readAsDataURL(file);
  });
</script>

</body>
</html>
