<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>–ß–∞—Ç (—Ç—ë–º–Ω–∞—è —Ç–µ–º–∞, –∞–¥–∞–ø—Ç–∏–≤)</title>
<style>
  /* –û–±—â–∏–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –∏ —à—Ä–∏—Ñ—Ç—ã */
  body, html {
    margin: 0; padding: 0; height: 100%;
    background: #121916;
    color: #c1d8c1;
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    display: flex;
    flex-direction: column;
    user-select: none;
  }

  h2 {
    margin: 0;
    padding: 20px 0;
    text-align: center;
    font-weight: 700;
    font-size: 1.5rem;
    color: #7fa57f;
    text-shadow: 0 0 5px #4a6f4a;
    background-color: #1e2a20;
    border-bottom: 1px solid #3a553a;
    flex-shrink: 0;
    display: flex;
    justify-content: center;
    align-items: center;
  }
  h2 a {
    margin-left: 15px;
    font-size: 0.9rem;
    color: #4caf50;
    text-decoration: none;
    font-weight: 600;
  }
  h2 a:hover {
    text-decoration: underline;
  }

  #messages {
    flex-grow: 1;
    overflow-y: auto;
    padding: 15px 10px;
    background: #1e2a20;
    border-top: 1px solid #3a553a;
    border-bottom: 1px solid #3a553a;
  }

  .message {
    margin-bottom: 12px;
    line-height: 1.3;
  }

  .message .username {
    font-weight: 700;
    color: #7fa57f;
    cursor: default; /* –æ—Ç–∫–ª—é—á–∏–ª –ø–µ—Ä–µ—Ö–æ–¥ –ø–æ –∫–ª–∏–∫—É */
    user-select: text;
  }

  .message .reply-btn {
    margin-left: 8px;
    font-size: 0.8rem;
    color: #a8c6a8;
    cursor: pointer;
    user-select: none;
  }
  .message .reply-btn:hover {
    color: #4caf50;
    text-decoration: underline;
  }

  .message .status-indicator {
    display: inline-block;
    width: 10px;
    height: 10px;
    border-radius: 50%;
    margin-right: 6px;
    vertical-align: middle;
  }
  .online {
    background-color: #4caf50;
  }
  .offline {
    background-color: #7a7a7a;
  }

  .message-text {
    margin-left: 18px;
    display: inline-block;
    vertical-align: middle;
    word-break: break-word;
  }

  .file-link {
    color: #81c784;
    text-decoration: underline;
    cursor: pointer;
  }
  .file-link:hover {
    color: #4caf50;
  }

  .file-image {
    max-width: 180px;
    max-height: 120px;
    border-radius: 6px;
    margin-top: 6px;
    border: 1px solid #3a553a;
    display: block;
    cursor: pointer;
  }

  #input-area {
    display: flex;
    gap: 10px;
    padding: 12px 15px;
    background: #1e2a20;
    border-top: 1px solid #3a553a;
    flex-shrink: 0;
    align-items: center;
  }

  #msg-input {
    flex-grow: 1;
    padding: 12px 15px;
    font-size: 1rem;
    border: none;
    border-radius: 25px;
    background: #2a3b2a;
    color: #c1d8c1;
    box-shadow: inset 0 0 5px #395039;
    outline: none;
    user-select: text;
  }

  #msg-input::placeholder {
    color: #7fa57faa;
  }

  #send-btn {
    background: #4caf50;
    border: none;
    color: #121916;
    font-weight: 700;
    font-size: 1rem;
    padding: 0 20px;
    border-radius: 25px;
    cursor: pointer;
    box-shadow: 0 0 12px #4caf50;
    transition: background-color 0.3s ease;
    user-select: none;
  }
  #send-btn:hover {
    background: #357a35;
  }

  #attach-btn {
    font-size: 1.5rem;
    background: none;
    border: none;
    color: #4caf50;
    cursor: pointer;
    padding: 0;
    user-select: none;
  }
  #attach-btn:hover {
    color: #357a35;
  }

  /* –ú–æ–±–∏–ª—å–Ω–∞—è –∞–¥–∞–ø—Ç–∏–≤–Ω–æ—Å—Ç—å */
  @media (max-width: 480px) {
    h2 {
      font-size: 1.2rem;
      padding: 16px 10px;
    }
    #input-area {
      padding: 10px;
    }
    #msg-input {
      font-size: 0.9rem;
      padding: 10px 12px;
    }
    #send-btn {
      font-size: 0.9rem;
      padding: 0 14px;
    }
  }

  /* –°–∫—Ä—ã—Ç—ã–π –∏–Ω–ø—É—Ç –¥–ª—è —Ñ–∞–π–ª–æ–≤ */
  .hidden-file-input {
    display: none;
  }
</style>
<script src="https://cdn.socket.io/4.5.4/socket.io.min.js"></script>
</head>
<body>

<h2>–ß–∞—Ç <a href="/logout" id="logout-link">–í—ã—Ö–æ–¥</a></h2>

<div id="messages" role="log" aria-live="polite" aria-relevant="additions"></div>

<div id="input-area">
  <input type="text" id="msg-input" placeholder="–í–≤–µ–¥–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ..." autocomplete="off" />
  <button id="send-btn" aria-label="–û—Ç–ø—Ä–∞–≤–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
  <button id="attach-btn" aria-label="–ü—Ä–∏–∫—Ä–µ–ø–∏—Ç—å —Ñ–∞–π–ª">üìé</button>
</div>

<input type="file" id="file-input" class="hidden-file-input" aria-hidden="true" />

<script>
  const socket = io();

  const messagesDiv = document.getElementById('messages');
  const input = document.getElementById('msg-input');
  const sendBtn = document.getElementById('send-btn');
  const attachBtn = document.getElementById('attach-btn');
  const fileInput = document.getElementById('file-input');

  let userStatuses = {};  // –û–±–Ω–æ–≤–ª—è–µ—Ç—Å—è —Å —Å–µ—Ä–≤–µ—Ä–∞
  let fileSendTarget = null;

  // –î–æ–±–∞–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –≤ —á–∞—Ç
  function addMessage(msg) {
    const div = document.createElement('div');
    div.className = 'message';

    const statusSpan = document.createElement('span');
    statusSpan.className = 'status-indicator';
    if(userStatuses[msg.user] === 'online') statusSpan.classList.add('online');
    else statusSpan.classList.add('offline');

    const usernameSpan = document.createElement('span');
    usernameSpan.className = 'username';
    usernameSpan.textContent = msg.user;
    // –ù–∞–∂–∞—Ç–∏–µ –Ω–∞ –∏–º—è –Ω–∏—á–µ–≥–æ –Ω–µ –¥–µ–ª–∞–µ—Ç

    const replyBtn = document.createElement('span');
    replyBtn.className = 'reply-btn';
    replyBtn.textContent = '[–û—Ç–≤–µ—Ç–∏—Ç—å]';
    replyBtn.addEventListener('click', () => {
      input.value = '@' + msg.user + ', ';
      input.focus();
    });

    div.appendChild(statusSpan);
    div.appendChild(usernameSpan);
    div.appendChild(replyBtn);

    if (msg.file) {
      const fileUrl = msg.file.data;
      const fileType = msg.file.type || '';
      const fileName = msg.file.name || 'file';

      if (fileType.startsWith('image/')) {
        const a = document.createElement('a');
        a.href = fileUrl;
        a.download = fileName;
        a.title = `–°–∫–∞—á–∞—Ç—å ${fileName}`;

        const img = document.createElement('img');
        img.src = fileUrl;
        img.alt = fileName;
        img.className = 'file-image';

        a.appendChild(img);
        div.appendChild(document.createTextNode(': '));
        div.appendChild(a);

      } else if (fileType.startsWith('video/')) {
        // –í–∏–¥–µ–æ –∏ —Å—Å—ã–ª–∫–∞ –Ω–∞ —Å–∫–∞—á–∏–≤–∞–Ω–∏–µ
        const video = document.createElement('video');
        video.controls = true;
        video.src = fileUrl;
        video.style.maxWidth = '300px';
        video.style.maxHeight = '200px';
        video.title = fileName;

        const downloadLink = document.createElement('a');
        downloadLink.href = fileUrl;
        downloadLink.download = fileName;
        downloadLink.textContent = `–°–∫–∞—á–∞—Ç—å –≤–∏–¥–µ–æ: ${fileName}`;
        downloadLink.style.display = 'block';
        downloadLink.style.color = '#81c784';
        downloadLink.style.marginTop = '6px';

        div.appendChild(document.createTextNode(': '));
        div.appendChild(video);
        div.appendChild(downloadLink);

      } else {
        const a = document.createElement('a');
        a.href = fileUrl;
        a.textContent = `[–§–∞–π–ª: ${fileName}]`;
        a.className = 'file-link';
        a.download = fileName;
        a.target = '_blank';

        div.appendChild(document.createTextNode(': '));
        div.appendChild(a);
      }
    } else {
      // –û–±—ã—á–Ω—ã–π —Ç–µ–∫—Å—Ç
      const textSpan = document.createElement('span');
      textSpan.className = 'message-text';
      textSpan.textContent = ': ' + msg.text;
      div.appendChild(textSpan);
    }

    messagesDiv.appendChild(div);
    messagesDiv.scrollTop = messagesDiv.scrollHeight;
  }

  socket.on('user_statuses', (statuses) => {
    userStatuses = statuses;
  });

  socket.on('load_messages', msgs => {
    messagesDiv.innerHTML = '';
    msgs.forEach(addMessage);
  });

  socket.on('new_message', addMessage);

  socket.on('new_file', msg => {
    addMessage({
      user: msg.user,
      file: {
        name: msg.filename,
        type: msg.filedata.split(';')[0].split(':')[1],
        data: msg.filedata
      }
    });
  });

  sendBtn.addEventListener('click', () => {
    const text = input.value.trim();
    if (!text) return;
    socket.emit('send_message', { text });
    input.value = '';
  });

  input.addEventListener('keydown', e => {
    if (e.key === 'Enter') {
      sendBtn.click();
      e.preventDefault();
    }
  });

  attachBtn.addEventListener('click', () => {
    fileInput.click();
  });

  fileInput.addEventListener('change', () => {
    const file = fileInput.files[0];
    if (!file) return;
    const reader = new FileReader();

    reader.onload = () => {
      socket.emit('send_file', {
        toUser: fileSendTarget,
        filename: file.name,
        filedata: reader.result
      });
      fileInput.value = '';
      fileSendTarget = null;
    };

    reader.readAsDataURL(file);
  });
</script>

</body>
</html>
